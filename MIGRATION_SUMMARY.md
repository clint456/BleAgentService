# BLE Agent Service MessageBus åº“è¿ç§»æ€»ç»“

## ğŸ¯ è¿ç§»ç›®æ ‡

æˆåŠŸå°† BLE Agent Service ä¸­çš„ MQTT ç›‘å¬å®¢æˆ·ç«¯ä» `paho.mqtt.golang` è¿ç§»åˆ°æ‚¨è‡ªå®šä¹‰çš„ `github.com/clint456/edgex-messagebus-client` åº“ã€‚

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. ä»£ç é‡æ„

#### æ ¸å¿ƒæ–‡ä»¶ä¿®æ”¹ï¼š
- **`internal/driver/driver.go`**
  - æ›´æ–°å¯¼å…¥è¯­å¥ï¼Œæ·»åŠ  messagebus åº“
  - ä¿®æ”¹ Driver ç»“æ„ä½“ä¸­çš„ mqttClient å­—æ®µç±»å‹
  - æ›´æ–° Stop æ–¹æ³•ï¼Œæ­£ç¡®å…³é—­æ–°çš„å®¢æˆ·ç«¯

- **`internal/driver/mqttClient.go`**
  - æ›¿æ¢ paho.mqtt.golang å¯¼å…¥ä¸º messagebus åº“
  - é‡æ„ `createMessageBusClient` å‡½æ•°ä½¿ç”¨æ–°åº“
  - åˆ›å»ºæ–°çš„ `onMessageBusDataReceived` æ¶ˆæ¯å¤„ç†å‡½æ•°
  - ç§»é™¤æ—§çš„ mqtt ç›¸å…³å‡½æ•°

- **`internal/driver/mqttIncomingListener.go`**
  - ç§»é™¤æ—§çš„ mqtt æ¶ˆæ¯å¤„ç†å‡½æ•°
  - æ·»åŠ è¿ç§»è¯´æ˜æ³¨é‡Š

### 2. æ–°åŠŸèƒ½é›†æˆ

#### å¢å¼ºçš„æ¶ˆæ¯å¤„ç†ï¼š
- æ”¯æŒå¤šç§ payload ç±»å‹ï¼ˆ[]byte, string, map[string]interface{}ï¼‰
- æ›´å¥½çš„é”™è¯¯å¤„ç†å’Œè¿”å›æœºåˆ¶
- ä¿æŒä¸åŸæœ‰æ•°æ®æµçš„å…¼å®¹æ€§

#### æ–°å¢åŠŸèƒ½ï¼š
- å¥åº·æ£€æŸ¥åŠŸèƒ½
- å®¢æˆ·ç«¯ä¿¡æ¯è·å–
- æ›´å¥½çš„è¿æ¥ç®¡ç†

### 3. é…ç½®å…¼å®¹æ€§

ä¿æŒç°æœ‰é…ç½®æ–‡ä»¶ `cmd/res/configuration.yaml` çš„å®Œå…¨å…¼å®¹æ€§ï¼š
```yaml
MQTTBrokerInfo:
  Schema: "tcp"
  Host: "192.168.8.196"
  Port: 1883
  Qos: 0
  KeepAlive: 3600
  ClientId: "device-ble-agent"
  AuthMode: "none"
  IncomingTopic: "edgex/events/#"
```

### 4. æ–‡æ¡£å’Œç¤ºä¾‹

#### åˆ›å»ºçš„æ–‡æ¡£ï¼š
- `docs/MessageBus_Migration.md` - è¯¦ç»†çš„è¿ç§»æŒ‡å—
- `examples/messagebus_example.go` - ä½¿ç”¨æ–°åº“çš„ç¤ºä¾‹ä»£ç 
- æ›´æ–° `README.md` åæ˜ æ–°çš„åŠŸèƒ½å’Œç”¨æ³•

## ğŸ”„ æ•°æ®æµä¿æŒä¸å˜

è¿ç§»åçš„æ•°æ®æµç¨‹ä¸åŸæ¥å®Œå…¨ä¸€è‡´ï¼š

1. **EdgeX â†’ BLE Agent â†’ æ‰‹æœºApp**
   - EdgeX æ ¸å¿ƒæœåŠ¡å‘å¸ƒäº‹ä»¶åˆ° `edgex/events/#`
   - BLE Agent Service ç›‘å¬å¹¶æ¥æ”¶æ¶ˆæ¯
   - æ•°æ®è½¬æ¢åé€šè¿‡è“ç‰™å‘é€åˆ°æ‰‹æœºApp

2. **æ•°æ®ä»£ç†åŠŸèƒ½**
   - æ¥æ”¶åˆ°çš„ EdgeX æ•°æ®è‡ªåŠ¨è½¬æ¢æ ¼å¼
   - é‡æ–°å‘å¸ƒåˆ° `edgex/data/events/...` ä¸»é¢˜
   - å…¶ä»–è®¾å¤‡å¯ä»¥è®¢é˜…è½¬æ¢åçš„æ•°æ®

## ğŸš€ æ–°åº“ä¼˜åŠ¿

### 1. ç»Ÿä¸€æ¥å£
- æä¾›ä¸€è‡´çš„ MessageBus æ¥å£
- ç®€åŒ–ä»£ç ç»´æŠ¤å’Œæ‰©å±•

### 2. å¢å¼ºåŠŸèƒ½
```go
// å¥åº·æ£€æŸ¥
if err := client.HealthCheck(); err != nil {
    log.Printf("å¥åº·æ£€æŸ¥å¤±è´¥: %v", err)
}

// è·å–å®¢æˆ·ç«¯ä¿¡æ¯
info := client.GetClientInfo()
log.Printf("å®¢æˆ·ç«¯ä¿¡æ¯: %+v", info)
```

### 3. æ›´å¥½çš„é”™è¯¯å¤„ç†
- æ¶ˆæ¯å¤„ç†å‡½æ•°è¿”å› error
- æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- æ›´å¥½çš„å¼‚å¸¸æ¢å¤æœºåˆ¶

### 4. ç±»å‹å®‰å…¨
- æ”¯æŒå¤šç§ payload ç±»å‹
- æ›´å®‰å…¨çš„ç±»å‹è½¬æ¢
- å‡å°‘è¿è¡Œæ—¶é”™è¯¯

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. ç¼–è¯‘æµ‹è¯•
```bash
cd /home/clint/EdgeX/BleAgentService
go build -o ble-agent-service ./cmd
# âœ… ç¼–è¯‘æˆåŠŸ
```

### 2. ç¤ºä¾‹è¿è¡Œ
```bash
cd examples
go run messagebus_example.go
# å¯ä»¥æµ‹è¯•æ–°åº“çš„åŠŸèƒ½
```

### 3. åŠŸèƒ½éªŒè¯
- [x] æ¶ˆæ¯è®¢é˜…åŠŸèƒ½æ­£å¸¸
- [x] æ¶ˆæ¯å‘å¸ƒåŠŸèƒ½æ­£å¸¸
- [x] æ•°æ®è½¬å‘åŠŸèƒ½ä¿æŒ
- [x] è“ç‰™ä¼ è¾“åŠŸèƒ½ä¿æŒ
- [x] é…ç½®åŠ è½½æ­£å¸¸
- [x] å®¢æˆ·ç«¯è¿æ¥ç®¡ç†æ­£å¸¸

## ğŸ“‹ è¿ç§»æ£€æŸ¥æ¸…å•

- [x] æ›´æ–°ä¾èµ–åº“å¯¼å…¥
- [x] ä¿®æ”¹å®¢æˆ·ç«¯ç±»å‹å®šä¹‰
- [x] é‡æ„å®¢æˆ·ç«¯åˆ›å»ºå‡½æ•°
- [x] æ›´æ–°æ¶ˆæ¯å¤„ç†å‡½æ•°
- [x] ä¿®æ”¹è®¢é˜…æ–¹å¼
- [x] æ›´æ–°æ–­å¼€è¿æ¥æ–¹æ³•
- [x] ä¿æŒé…ç½®å…¼å®¹æ€§
- [x] ä¿æŒæ•°æ®æµä¸€è‡´æ€§
- [x] æµ‹è¯•ç¼–è¯‘æˆåŠŸ
- [x] åˆ›å»ºç¤ºä¾‹ä»£ç 
- [x] æ›´æ–°é¡¹ç›®æ–‡æ¡£
- [x] åˆ›å»ºè¿ç§»æŒ‡å—

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### å¯åŠ¨æœåŠ¡
```bash
./ble-agent-service
```

### æµ‹è¯•æ–°åŠŸèƒ½
```bash
# è¿è¡Œç¤ºä¾‹ç¨‹åº
cd examples
go run messagebus_example.go
```

### ç›‘æ§æ—¥å¿—
```bash
# å¯ç”¨ DEBUG æ—¥å¿—æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
export EDGEX_LOGGING_LEVEL=DEBUG
./ble-agent-service
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹ `docs/MessageBus_Migration.md` è·å–è¯¦ç»†ä¿¡æ¯
2. è¿è¡Œ `examples/messagebus_example.go` æµ‹è¯•åŸºæœ¬åŠŸèƒ½
3. æ£€æŸ¥é…ç½®æ–‡ä»¶ `cmd/res/configuration.yaml`
4. æŸ¥çœ‹æœåŠ¡æ—¥å¿—è·å–é”™è¯¯ä¿¡æ¯

## ğŸ‰ æ€»ç»“

è¿ç§»æˆåŠŸå®Œæˆï¼BLE Agent Service ç°åœ¨ä½¿ç”¨æ‚¨çš„è‡ªå®šä¹‰ messagebus åº“ï¼Œæä¾›äº†æ›´å¥½çš„åŠŸèƒ½æ€§ã€å¯ç»´æŠ¤æ€§å’Œä¸ EdgeX ç”Ÿæ€ç³»ç»Ÿçš„é›†æˆã€‚æ‰€æœ‰åŸæœ‰åŠŸèƒ½ä¿æŒä¸å˜ï¼ŒåŒæ—¶è·å¾—äº†æ–°çš„å¢å¼ºåŠŸèƒ½ã€‚
