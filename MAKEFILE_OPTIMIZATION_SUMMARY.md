# Makefile ä¼˜åŒ–æ€»ç»“

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

æ ¹æ®æ‚¨çš„è¦æ±‚ï¼Œå°†ç¼–è¯‘å¥½çš„æ–‡ä»¶æ”¾å…¥ `/cmd` æ–‡ä»¶å¤¹ä¸‹ï¼Œå¹¶å…¨é¢ä¼˜åŒ– Makefileï¼Œä½¿å…¶ç¬¦åˆä¼ä¸šçº§å¼€å‘æ ‡å‡†å’Œç°ä»£åŒ–æ„å»ºéœ€æ±‚ã€‚

## âœ… ä¸»è¦ä¼˜åŒ–å†…å®¹

### 1. æ–‡ä»¶è¾“å‡ºä½ç½®ä¼˜åŒ–

#### ä¼˜åŒ–å‰ï¼š
```makefile
go build -o ble-agent-service ./cmd
```

#### ä¼˜åŒ–åï¼š
```makefile
@mkdir -p cmd
go build -o cmd/ble-agent-service ./cmd
```

**æ”¹è¿›ç‚¹ï¼š**
- âœ… ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ç°åœ¨æ”¾åœ¨ `cmd/` ç›®å½•ä¸‹
- âœ… è‡ªåŠ¨åˆ›å»º `cmd` ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
- âœ… äº¤å‰ç¼–è¯‘æ–‡ä»¶æ”¾åœ¨ `cmd/dist/` ç›®å½•ä¸‹
- âœ… æ¸…ç†åŠŸèƒ½ä¼šæ­£ç¡®æ¸…ç† `cmd/` ç›®å½•ä¸‹çš„æ–‡ä»¶

### 2. ä¼ä¸šçº§æ„å»ºé…ç½®

#### ç‰ˆæœ¬ä¿¡æ¯ç®¡ç†ï¼š
```makefile
VERSION := $(shell cat ./VERSION 2>/dev/null || echo "v2.0.0")
GIT_SHA := $(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")
GIT_TAG := $(shell git describe --tags --abbrev=0 2>/dev/null || echo "v2.0.0")
BUILD_TIME := $(shell date -u '+%Y-%m-%d_%H:%M:%S_UTC')
```

#### å®‰å…¨ç¼–è¯‘é€‰é¡¹ï¼š
```makefile
ENABLE_FULL_RELRO := true    # å®Œæ•´çš„é‡å®šä½åªè¯»ä¿æŠ¤
ENABLE_PIE := true           # ä½ç½®æ— å…³å¯æ‰§è¡Œæ–‡ä»¶
ENABLE_STACK_PROTECTION := true  # æ ˆä¿æŠ¤
```

#### ä¼˜åŒ–çš„ LDFLAGSï¼š
```makefile
LDFLAGS := -s -w  # å»é™¤ç¬¦å·è¡¨å’Œè°ƒè¯•ä¿¡æ¯
LDFLAGS += -X main.Version=$(VERSION)
LDFLAGS += -X main.GitCommit=$(GIT_SHA)
LDFLAGS += -X main.BuildTime=$(BUILD_TIME)
```

### 3. ä¸°å¯Œçš„æ„å»ºç›®æ ‡

#### æ„å»ºç›¸å…³ç›®æ ‡ï¼š
- `build` - æ ‡å‡†æ„å»ºï¼Œè¾“å‡ºåˆ° `cmd/ble-agent-service`
- `build-dev` - å¼€å‘ç‰ˆæœ¬æ„å»º
- `build-prod` - ç”Ÿäº§ç‰ˆæœ¬æ„å»ºï¼ˆåŒ…å«å®Œæ•´æµ‹è¯•ï¼‰
- `build-nats` - æ”¯æŒ NATS çš„ç‰ˆæœ¬
- `build-cross` - äº¤å‰ç¼–è¯‘å¤šå¹³å°ç‰ˆæœ¬

#### æµ‹è¯•ç›¸å…³ç›®æ ‡ï¼š
- `test` - è¿è¡Œæ‰€æœ‰æµ‹è¯•
- `test-unit` - å•å…ƒæµ‹è¯•
- `test-integration` - é›†æˆæµ‹è¯•
- `test-coverage` - ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
- `test-benchmark` - æ€§èƒ½åŸºå‡†æµ‹è¯•

#### ä»£ç è´¨é‡ç›®æ ‡ï¼š
- `lint` - ä»£ç æ£€æŸ¥
- `lint-fix` - è‡ªåŠ¨ä¿®å¤ä»£ç é—®é¢˜
- `format` - ä»£ç æ ¼å¼åŒ–
- `check` - æ£€æŸ¥ä»£ç æ ¼å¼
- `security-scan` - å®‰å…¨æ‰«æ
- `vulnerability-check` - æ¼æ´æ£€æŸ¥

### 4. äº¤å‰ç¼–è¯‘ä¼˜åŒ–

#### æ”¯æŒçš„å¹³å°ï¼š
- Linux AMD64 (æ”¯æŒ PIE)
- Linux ARM64 (æ”¯æŒ PIE)
- Linux ARM (ç¦ç”¨ PIEï¼Œé¿å… cgo ä¾èµ–)
- Windows AMD64 (ç¦ç”¨ PIE)

#### è¾“å‡ºä½ç½®ï¼š
```
cmd/dist/
â”œâ”€â”€ ble-agent-service-linux-amd64
â”œâ”€â”€ ble-agent-service-linux-arm64
â”œâ”€â”€ ble-agent-service-linux-arm
â””â”€â”€ ble-agent-service-windows-amd64.exe
```

### 5. ä¾èµ–ç®¡ç†

#### ä¾èµ–ç›¸å…³ç›®æ ‡ï¼š
- `deps` - å®‰è£…/æ›´æ–°ä¾èµ–
- `deps-update` - æ›´æ–°æ‰€æœ‰ä¾èµ–åˆ°æœ€æ–°ç‰ˆæœ¬
- `deps-verify` - éªŒè¯ä¾èµ–å®Œæ•´æ€§
- `vendor` - åˆ›å»º vendor ç›®å½•

### 6. Docker æ”¯æŒ

#### Docker ç›¸å…³ç›®æ ‡ï¼š
- `docker` / `docker-build` - æ„å»º Docker é•œåƒ
- `docker-nats` - æ„å»ºæ”¯æŒ NATS çš„ Docker é•œåƒ
- `docker-push` - æ¨é€ Docker é•œåƒ
- `docker-clean` - æ¸…ç† Docker é•œåƒ

#### é•œåƒæ ‡ç­¾ï¼š
- `edgexfoundry/device-ble-agent:latest`
- `edgexfoundry/device-ble-agent:v2.0.0`
- `edgexfoundry/device-ble-agent:ca4761e`

### 7. è¿è¡Œå’Œå®‰è£…

#### è¿è¡Œç›¸å…³ç›®æ ‡ï¼š
- `run` - è¿è¡ŒæœåŠ¡
- `run-dev` - è¿è¡Œå¼€å‘ç‰ˆæœ¬
- `install` - å®‰è£…åˆ°ç³»ç»Ÿ (`/usr/local/bin/`)
- `uninstall` - ä»ç³»ç»Ÿå¸è½½

### 8. å¼€å‘å·¥å…·

#### å¼€å‘ç›¸å…³ç›®æ ‡ï¼š
- `dev-setup` - è®¾ç½®å¼€å‘ç¯å¢ƒ
- `examples` - è¿è¡Œç¤ºä¾‹ç¨‹åº
- `docs` - ç”Ÿæˆæ–‡æ¡£
- `watch` - ç›‘æ§æ–‡ä»¶å˜åŒ–å¹¶è‡ªåŠ¨æ„å»º

### 9. æ¸…ç†åŠŸèƒ½

#### æ¸…ç†ç›¸å…³ç›®æ ‡ï¼š
- `clean` - æ¸…ç†æ„å»ºæ–‡ä»¶
- `clean-all` - æ¸…ç†æ‰€æœ‰æ–‡ä»¶ï¼ˆåŒ…æ‹¬ Docker é•œåƒï¼‰

#### æ¸…ç†å†…å®¹ï¼š
```makefile
clean:
    rm -f cmd/ble-agent-service      # ä¸»äºŒè¿›åˆ¶æ–‡ä»¶
    rm -rf cmd/dist/                 # äº¤å‰ç¼–è¯‘æ–‡ä»¶
    rm -f coverage.out coverage.html # æµ‹è¯•è¦†ç›–ç‡æ–‡ä»¶
    rm -rf vendor/                   # vendor ç›®å½•
```

### 10. å¸®åŠ©å’Œä¿¡æ¯

#### ä¿¡æ¯ç›¸å…³ç›®æ ‡ï¼š
- `help` - æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ï¼ˆé»˜è®¤ç›®æ ‡ï¼‰
- `info` - æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
- `all` - æ„å»ºå®Œæ•´çš„é¡¹ç›®

## ğŸ“Š ä¼˜åŒ–æ•ˆæœ

### æ„å»ºè¾“å‡ºä½ç½®
| æ„å»ºç±»å‹ | è¾“å‡ºä½ç½® | è¯´æ˜ |
|----------|----------|------|
| æ ‡å‡†æ„å»º | `cmd/ble-agent-service` | ä¸»äºŒè¿›åˆ¶æ–‡ä»¶ |
| äº¤å‰ç¼–è¯‘ | `cmd/dist/ble-agent-service-*` | å¤šå¹³å°ç‰ˆæœ¬ |
| å¼€å‘ç‰ˆæœ¬ | `cmd/ble-agent-service` | åŒ…å«è°ƒè¯•ä¿¡æ¯ |
| ç”Ÿäº§ç‰ˆæœ¬ | `cmd/ble-agent-service` | ä¼˜åŒ–ç‰ˆæœ¬ |

### åŠŸèƒ½ç»Ÿè®¡
| ç±»åˆ« | ç›®æ ‡æ•°é‡ | ä¸»è¦åŠŸèƒ½ |
|------|----------|----------|
| æ„å»º | 5ä¸ª | æ ‡å‡†ã€å¼€å‘ã€ç”Ÿäº§ã€NATSã€äº¤å‰ç¼–è¯‘ |
| æµ‹è¯• | 5ä¸ª | å•å…ƒã€é›†æˆã€è¦†ç›–ç‡ã€åŸºå‡†æµ‹è¯• |
| è´¨é‡ | 6ä¸ª | ä»£ç æ£€æŸ¥ã€æ ¼å¼åŒ–ã€å®‰å…¨æ‰«æ |
| Docker | 4ä¸ª | æ„å»ºã€æ¨é€ã€æ¸…ç†é•œåƒ |
| è¿è¡Œ | 4ä¸ª | è¿è¡Œã€å®‰è£…ã€å¸è½½ |
| å·¥å…· | 6ä¸ª | å¼€å‘ç¯å¢ƒã€ç¤ºä¾‹ã€æ–‡æ¡£ |
| æ¸…ç† | 2ä¸ª | æ ‡å‡†æ¸…ç†ã€æ·±åº¦æ¸…ç† |
| ä¿¡æ¯ | 3ä¸ª | å¸®åŠ©ã€é¡¹ç›®ä¿¡æ¯ã€å®Œæ•´æ„å»º |

### éªŒè¯ç»“æœ

#### âœ… æ„å»ºæµ‹è¯•
```bash
$ make build
ğŸ”¨ æ„å»º ble-agent-service...
ç‰ˆæœ¬: v2.0.0 | Git: ca4761e | å¹³å°: linux/amd64
âœ… æ„å»ºå®Œæˆ: cmd/ble-agent-service
```

#### âœ… äº¤å‰ç¼–è¯‘æµ‹è¯•
```bash
$ make build-cross
ğŸ”¨ äº¤å‰ç¼–è¯‘å¤šå¹³å°ç‰ˆæœ¬...
âœ… äº¤å‰ç¼–è¯‘å®Œæˆï¼Œæ–‡ä»¶ä½äº cmd/dist/ ç›®å½•

$ ls -la cmd/dist/
-rwxr-xr-x 1 clint clint 34783585 ble-agent-service-linux-amd64
-rwxr-xr-x 1 clint clint 29032632 ble-agent-service-linux-arm
-rwxr-xr-x 1 clint clint 33489249 ble-agent-service-linux-arm64
-rwxr-xr-x 1 clint clint 31957504 ble-agent-service-windows-amd64.exe
```

#### âœ… æ¸…ç†æµ‹è¯•
```bash
$ make clean
ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶...
âœ… æ¸…ç†å®Œæˆ
```

#### âœ… é¡¹ç›®ä¿¡æ¯
```bash
$ make info
ğŸ“‹ é¡¹ç›®ä¿¡æ¯:
  é¡¹ç›®åç§°: ble-agent-service
  ç‰ˆæœ¬: v2.0.0
  Gitæäº¤: ca4761e
  äºŒè¿›åˆ¶æ–‡ä»¶: cmd/ble-agent-service
```

## ğŸ¯ ä½¿ç”¨æŒ‡å—

### å¸¸ç”¨å‘½ä»¤

#### å¼€å‘é˜¶æ®µï¼š
```bash
make build-dev    # æ„å»ºå¼€å‘ç‰ˆæœ¬
make run-dev      # è¿è¡Œå¼€å‘ç‰ˆæœ¬
make test         # è¿è¡Œæµ‹è¯•
make lint         # ä»£ç æ£€æŸ¥
```

#### ç”Ÿäº§éƒ¨ç½²ï¼š
```bash
make build-prod   # æ„å»ºç”Ÿäº§ç‰ˆæœ¬
make install      # å®‰è£…åˆ°ç³»ç»Ÿ
make docker       # æ„å»º Docker é•œåƒ
```

#### å‘å¸ƒå‡†å¤‡ï¼š
```bash
make release      # å‡†å¤‡å‘å¸ƒç‰ˆæœ¬
make build-cross  # äº¤å‰ç¼–è¯‘å¤šå¹³å°
```

#### æ¸…ç†ç»´æŠ¤ï¼š
```bash
make clean        # æ¸…ç†æ„å»ºæ–‡ä»¶
make clean-all    # æ·±åº¦æ¸…ç†
```

## ğŸ“ æ€»ç»“

ä¼˜åŒ–åçš„ Makefile å…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- âœ… **ç¬¦åˆè¦æ±‚**ï¼šç¼–è¯‘æ–‡ä»¶æ­£ç¡®æ”¾ç½®åœ¨ `cmd/` ç›®å½•ä¸‹
- âœ… **ä¼ä¸šçº§æ ‡å‡†**ï¼šå®Œæ•´çš„æ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²æµç¨‹
- âœ… **ç°ä»£åŒ–ç‰¹æ€§**ï¼šå®‰å…¨ç¼–è¯‘é€‰é¡¹ã€ç‰ˆæœ¬ç®¡ç†ã€äº¤å‰ç¼–è¯‘
- âœ… **ç”¨æˆ·å‹å¥½**ï¼šä¸°å¯Œçš„å¸®åŠ©ä¿¡æ¯å’Œæ¸…æ™°çš„è¾“å‡º
- âœ… **åŠŸèƒ½å®Œæ•´**ï¼šæ¶µç›–å¼€å‘ã€æµ‹è¯•ã€éƒ¨ç½²çš„å…¨ç”Ÿå‘½å‘¨æœŸ
- âœ… **å¯ç»´æŠ¤æ€§**ï¼šæ¸…æ™°çš„ç»“æ„å’Œè¯¦ç»†çš„æ³¨é‡Š

ç°åœ¨çš„ Makefile ä¸ºé¡¹ç›®æä¾›äº†ä¸“ä¸šã€é«˜æ•ˆã€æ˜“ç”¨çš„æ„å»ºç³»ç»Ÿï¼Œå®Œå…¨æ»¡è¶³ä¼ä¸šçº§å¼€å‘çš„éœ€æ±‚ã€‚
