# BLE Agent Service 详细设计方案

## 1. 项目概述

### 1.1 项目背景
BLE Agent Service 是一个基于 EdgeX Foundry 框架的设备服务，旨在构建一个完整的蓝牙代理系统。该系统由手机 App 控制端与蓝牙服务端组成，专注于桥接手机 APP 与 EdgeX 微服务，为物联网设备提供完整的连接解决方案。

### 1.2 核心价值
- **桥接功能**：实现手机 App 与 EdgeX 微服务之间的无缝连接
- **监测控制**：手机 App 可通过蓝牙连接实现对 EdgeX 服务的实时监测与控制
- **数据代理**：将 EdgeX 数据转化为用户友好的数据格式，重新发布到消息总线
- **设备集成**：作为 EdgeX 设备服务，完全集成到 EdgeX 生态系统中

### 1.3 技术特点
- 基于 EdgeX Foundry v4.0 框架
- 支持蓝牙低功耗（BLE）通信
- 集成串口通信、MQTT 消息传输和 EdgeX MessageBus
- 采用 Go 语言开发，具备高性能和并发处理能力

## 2. 系统架构设计

### 2.1 整体架构图

```
┌─────────────────┐    蓝牙连接    ┌─────────────────┐    串口通信    ┌─────────────────┐
│   手机App控制端  │◄─────────────►│  BLE 控制器     │◄─────────────►│  串口通信模块    │
└─────────────────┘                └─────────────────┘                └─────────────────┘
                                            │                                   │
                                            │ AT命令交互                         │ 数据队列
                                            ▼                                   ▼
┌─────────────────┐    消息转发    ┌─────────────────┐    数据发布    ┌─────────────────┐
│  MQTT Broker    │◄─────────────►│   MQTT 客户端   │◄─────────────►│ EdgeX MessageBus│
└─────────────────┘                └─────────────────┘                └─────────────────┘
                                            │                                   │
                                            │ 数据代理                           │ 服务集成
                                            ▼                                   ▼
                                   ┌─────────────────┐                ┌─────────────────┐
                                   │   数据转换器     │                │  EdgeX Core     │
                                   └─────────────────┘                │   Services      │
                                                                     └─────────────────┘
```

### 2.2 架构层次
1. **应用层**：手机 App 控制端，提供用户交互界面
2. **通信层**：BLE 控制器，负责蓝牙通信协议处理
3. **传输层**：串口通信模块，提供底层数据传输
4. **消息层**：MQTT 客户端和 EdgeX MessageBus，实现消息路由
5. **服务层**：EdgeX 核心服务，提供设备管理和数据处理
6. **代理层**：数据转换器，实现数据格式转换和重新发布

### 2.3 数据流向
- **上行数据流**：手机App → BLE控制器 → 串口通信 → MQTT客户端 → EdgeX MessageBus → EdgeX核心服务
- **下行数据流**：EdgeX核心服务 → EdgeX MessageBus → MQTT客户端 → 数据转换器 → BLE控制器 → 手机App
- **代理数据流**：EdgeX数据 → 数据转换器 → 消息总线重新发布 → 其他设备/服务

## 3. 核心组件设计

### 3.1 手机 App 控制端

#### 3.1.1 功能职责
- **用户界面**：提供直观的用户交互界面
- **蓝牙连接管理**：建立和维护与BLE服务端的连接
- **数据展示**：实时显示EdgeX服务状态和设备数据
- **命令发送**：向EdgeX服务发送控制命令
- **状态监控**：监控EdgeX服务和设备的运行状态

#### 3.1.2 关键接口
- **蓝牙连接接口**：`connectToBleService()`, `disconnectFromBleService()`
- **数据展示接口**：`displayDeviceData()`, `displayServiceStatus()`
- **命令发送接口**：`sendControlCommand()`, `sendConfigCommand()`
- **状态监控接口**：`monitorServiceHealth()`, `getDeviceStatus()`

#### 3.1.3 技术实现
- 支持Android/iOS平台
- 使用原生蓝牙API或跨平台框架
- 实现GATT客户端功能
- 支持数据分包传输和重组

### 3.2 BLE 控制器 (BleController)

#### 3.2.1 功能职责
- **设备初始化**：初始化BLE外围设备模式
- **广播管理**：启动和管理BLE广播，使手机App能够发现服务
- **GATT服务**：提供GATT服务和特征值配置
- **AT命令处理**：执行完整的BLE AT命令集
- **数据桥接**：在手机App与EdgeX服务之间转发数据

#### 3.2.2 关键接口
```go
type BleController struct {
    serial *SerialPort
    queue  *SerialQueue
    debug  bool
}

// 核心方法
func (b *BleController) InitAsPeripheral() error
func (b *BleController) sendCommand(cmd BleCommand) (string, error)
func (b *BleController) StartAdvertising() error
func (b *BleController) StopAdvertising() error
```

#### 3.2.3 AT命令集
- `AT+QRST`：设备重置
- `AT+QBLEINIT=2`：初始化为外围设备
- `AT+QBLEADVPARAM=150,150`：设置广播参数
- `AT+QBLEGATTSSRV=fff1`：创建GATT服务
- `AT+QBLEGATTSCHAR=fff2`：创建GATT特征值
- `AT+QBLENAME=QuecHCM111Z`：设置设备名称
- `AT+QBLEADVSTART`：启动广播

### 3.3 串口通信模块 (SerialPort & SerialQueue)

#### 3.3.1 功能职责
- **连接管理**：建立和维护串口连接
- **数据传输**：处理串口数据的发送和接收
- **队列管理**：实现串口数据队列和缓冲管理
- **超时控制**：提供可配置的读写超时机制
- **线程安全**：使用mutex保护并发访问

#### 3.3.2 核心结构
```go
type SerialPort struct {
    port   *serial.Port
    reader *bufio.Reader
    lock   sync.Mutex
    Debug  bool
}

type SerialQueue struct {
    port    *SerialPort
    reqChan chan SerialRequest
    quit    chan struct{}
}
```

#### 3.3.3 关键特性
- 基于`github.com/tarm/serial`库
- 支持115200波特率
- 实现请求-响应队列机制
- 提供超时和错误处理
- 支持调试模式输出

### 3.4 MQTT 客户端

#### 3.4.1 双客户端架构
- **监听客户端**：订阅EdgeX事件，接收数据
- **转发客户端**：基于go-mod-messaging，发布数据到MessageBus

#### 3.4.2 功能特性
- **自动重连**：连接断开时自动重连
- **消息转发**：自动将接收到的消息转发到MessageBus
- **认证支持**：支持用户名/密码认证
- **QoS控制**：支持MQTT QoS级别配置

#### 3.4.3 配置参数
```yaml
MQTTBrokerInfo:
  Schema: "tcp"
  Host: "192.168.8.196"
  Port: 1883
  Qos: 0
  KeepAlive: 3600
  ClientId: "device-ble-agent"
  AuthMode: "none"
  IncomingTopic: "edgex/events/#"
```

#### 3.4.4 核心实现
```go
func (s *Driver) initialMqttClient() error
func (s *Driver) createMqttClient(serviceConfig *ServiceConfig) (mqtt.Client, errors.EdgeX)
func (s *Driver) onIncomingDataReceived(client mqtt.Client, message mqtt.Message)
```

### 3.5 EdgeX MessageBus 客户端

#### 3.5.1 功能特性
- **完整API**：支持发布、订阅、请求-响应模式
- **多数据类型**：支持JSON、字符串、二进制数据
- **线程安全**：所有操作都是线程安全的
- **错误处理**：完善的错误处理和重试机制
- **健康检查**：实时监控客户端状态

#### 3.5.2 核心接口
```go
func (s *Driver) InitMessageBusClient(ClientID string, Host string, Port int) (messaging.MessageClient, errors.EdgeX)
func (s *Driver) MessageBusPub(pub messaging.MessageClient, ClientID string, Topic string, data map[string]interface{}) errors.EdgeX
```

#### 3.5.3 消息格式
```go
type MessageEnvelope struct {
    CorrelationID string
    Payload       interface{}
    ContentType   string
}
```

### 3.6 数据转换器和发布器

#### 3.6.1 数据代理功能
- **格式转换**：将EdgeX数据转换为用户友好格式
- **重新发布**：转换后的数据发布到指定主题
- **路由控制**：支持灵活的消息路由配置

#### 3.6.2 实现机制
```go
func (s *Driver) publishToMessageBus(data map[string]interface{}, topic string) error
func (s *Driver) sendToBluetoothTransmitter(data map[string]interface{})
```

#### 3.6.3 数据分包传输
- **MTU限制**：支持247字节MTU限制
- **分包机制**：自动将大数据包分割为小包
- **重组功能**：接收端自动重组分包数据
- **错误恢复**：支持分包传输错误恢复

```go
type Packet struct {
    Index   uint16 // 分包索引
    Total   uint16 // 总分包数
    Payload []byte // 数据载荷
}
```

## 4. 数据流设计

### 4.1 手机 App 到 EdgeX 的控制流程

#### 4.1.1 流程步骤
1. **连接建立**：手机App通过蓝牙扫描发现BLE服务端
2. **GATT连接**：App连接到BLE服务端的GATT服务
3. **命令发送**：App通过GATT特征值发送控制命令
4. **串口传输**：BLE控制器通过串口接收命令数据
5. **格式转换**：命令数据转换为EdgeX MessageBus格式
6. **消息路由**：通过MQTT客户端转发到EdgeX核心服务
7. **命令执行**：EdgeX核心服务执行相应的设备操作
8. **结果返回**：执行结果通过相同路径返回到手机App

#### 4.1.2 数据格式
```json
{
  "deviceName": "Uart-Ble-Device",
  "command": "set_parameter",
  "parameters": {
    "key": "value"
  },
  "timestamp": "2024-01-01T00:00:00Z"
}
```

### 4.2 EdgeX 到手机 App 的数据流程

#### 4.2.1 流程步骤
1. **事件产生**：EdgeX核心服务产生设备事件或数据
2. **消息发布**：事件通过EdgeX MessageBus发布
3. **MQTT监听**：BLE Agent Service的MQTT客户端接收消息
4. **数据处理**：对接收到的数据进行格式转换和处理
5. **分包传输**：大数据包自动分割为适合蓝牙传输的小包
6. **蓝牙发送**：通过BLE控制器发送到手机App
7. **数据重组**：手机App接收并重组分包数据
8. **界面显示**：在App界面上显示设备数据和状态

#### 4.2.2 事件格式
```json
{
  "apiVersion": "v4",
  "id": "uuid",
  "deviceName": "sensor-device",
  "profileName": "sensor-profile",
  "sourceName": "temperature",
  "origin": 1640995200000,
  "readings": [
    {
      "id": "uuid",
      "origin": 1640995200000,
      "deviceName": "sensor-device",
      "resourceName": "temperature",
      "profileName": "sensor-profile",
      "valueType": "Float64",
      "value": "25.6"
    }
  ]
}
```

### 4.3 数据代理功能流程

#### 4.3.1 代理机制
1. **数据监听**：监听EdgeX MessageBus上的特定主题
2. **数据接收**：接收EdgeX核心服务发布的原始数据
3. **格式转换**：将EdgeX格式数据转换为用户定义格式
4. **主题映射**：根据配置将数据发布到指定主题
5. **消息分发**：其他设备或服务订阅转换后的数据

#### 4.3.2 转换规则
```go
// 原始EdgeX数据
edgexData := map[string]interface{}{
    "deviceName": "sensor01",
    "readings": []map[string]interface{}{
        {
            "resourceName": "temperature",
            "value": "25.6",
            "valueType": "Float64"
        }
    }
}

// 转换后的用户数据
userData := map[string]interface{}{
    "device": "sensor01",
    "temperature": 25.6,
    "unit": "°C",
    "timestamp": time.Now().Unix()
}
```

#### 4.3.3 主题路由
- **输入主题**：`edgex/events/#`
- **输出主题**：`edgex/data/events/device/{deviceName}`
- **自定义主题**：支持用户自定义主题格式

## 5. 配置管理

### 5.1 主要配置项

#### 5.1.1 服务配置
- **服务端口**：59995（默认）
- **日志级别**：DEBUG/INFO/WARN/ERROR
- **启动消息**：服务启动提示信息

#### 5.1.2 串口配置
- **设备路径**：`/dev/ttyS3`（Linux）或`COM3`（Windows）
- **波特率**：115200
- **数据位**：8
- **停止位**：1
- **校验位**：无

#### 5.1.3 MQTT配置
- **Broker地址**：192.168.8.196
- **端口**：1883
- **客户端ID**：device-ble-agent
- **认证模式**：none/usernamepassword
- **QoS级别**：0/1/2
- **保持连接**：3600秒

#### 5.1.4 BLE配置
- **设备名称**：QuecHCM111Z
- **广播间隔**：150ms
- **GATT服务UUID**：fff1
- **特征值UUID**：fff2
- **MTU大小**：247字节

#### 5.1.5 数据代理配置
- **监听主题**：edgex/events/#
- **转发主题前缀**：edgex/data
- **数据转换规则**：JSON格式转换
- **重试机制**：自动重试配置

### 5.2 配置文件结构

#### 5.2.1 主配置文件 (`cmd/res/configuration.yaml`)
```yaml
Writable:
  LogLevel: DEBUG

Service:
  Host: localhost
  Port: 59995
  StartupMsg: ble-agent-service started

Device:
  ProfilesDir: "./res/profiles"
  DevicesDir: "./res/devices"

MQTTBrokerInfo:
  Schema: "tcp"
  Host: "192.168.8.196"
  Port: 1883
  Qos: 0
  KeepAlive: 3600
  ClientId: "device-ble-agent"

  CredentialsRetryTime: 120
  CredentialsRetryWait: 1
  ConnEstablishingRetry: 10
  ConnRetryWaitTime: 5

  AuthMode: "none"
  CredentialsName: "credentials"

  IncomingTopic: "edgex/events/#"

  Writable:
    ResponseFetchInterval: 500
```

#### 5.2.2 设备配置文件 (`cmd/res/devices/devices.yaml`)
```yaml
deviceList:
  - name: "Uart-Ble-Device"
    profileName: "Uart-Ble-Device"
    description: "BLE Agent UART Device"
    labels:
      - "ble"
      - "uart"
      - "agent"
    protocols:
      UART:
        deviceLocation: "/dev/ttyS3"
        baudRate: 115200
        dataBits: 8
        stopBits: 1
        parity: "none"
    adminState: "UNLOCKED"
    operatingState: "UP"
```

#### 5.2.3 设备配置文件 (`cmd/res/profiles/generic.yaml`)
```yaml
name: "Uart-Ble-Device"
manufacturer: "EdgeX"
model: "BLE-Agent-v1.0"
labels:
  - "ble"
  - "uart"
description: "BLE Agent Device Profile"

deviceResources:
  - name: "String"
    isHidden: false
    description: "String data resource"
    attributes:
      primaryTable: "string_data"
    properties:
      valueType: "String"
      readWrite: "RW"

  - name: "JSON"
    isHidden: false
    description: "JSON data resource"
    attributes:
      primaryTable: "json_data"
    properties:
      valueType: "Object"
      readWrite: "RW"

deviceCommands:
  - name: "String"
    readWrite: "RW"
    isHidden: false
    resourceOperations:
      - deviceResource: "String"
        defaultValue: ""

  - name: "JSON"
    readWrite: "RW"
    isHidden: false
    resourceOperations:
      - deviceResource: "JSON"
        defaultValue: "{}"
```

### 5.3 配置管理机制

#### 5.3.1 配置加载
```go
type ServiceConfig struct {
    MQTTBrokerInfo MQTTBrokerInfo
}

func (s *Driver) loadConfiguration() error {
    s.serviceConfig = &ServiceConfig{}
    if err := s.sdk.LoadCustomConfig(s.serviceConfig, CustomConfigSectionName); err != nil {
        return fmt.Errorf("加载自定义配置失败: %s", err.Error())
    }
    return nil
}
```

#### 5.3.2 动态配置更新
```go
func (s *Driver) updateWritableConfig(rawWritableConfig interface{}) {
    updated, ok := rawWritableConfig.(*WritableInfo)
    if !ok {
        s.lc.Error("更新配置失败：类型转换错误")
        return
    }
    s.serviceConfig.MQTTBrokerInfo.Writable = *updated
}
```

#### 5.3.3 配置验证
```go
func (info *MQTTBrokerInfo) Validate() errors.EdgeX {
    if info.Writable.ResponseFetchInterval == 0 {
        return errors.NewCommonEdgeX(errors.KindContractInvalid,
            "ResponseFetchInterval不能为空", nil)
    }
    return nil
}
```

## 6. 部署和运维

### 6.1 系统要求

#### 6.1.1 硬件要求
- **处理器**：ARM Cortex-A7 或更高（如树莓派3B+）
- **内存**：最小512MB，推荐1GB以上
- **存储**：最小8GB SD卡，推荐16GB以上
- **串口**：支持UART串口的设备
- **蓝牙模块**：支持AT命令的BLE模块

#### 6.1.2 软件要求
- **操作系统**：Linux (推荐Ubuntu 18.04+)
- **Go版本**：Go 1.21或更高版本
- **EdgeX版本**：EdgeX Foundry v4.0
- **MQTT Broker**：Mosquitto或其他MQTT代理

#### 6.1.3 网络要求
- **局域网连接**：用于连接MQTT Broker
- **串口权限**：对串口设备的读写权限
- **防火墙配置**：开放服务端口59995

### 6.2 安装部署

#### 6.2.1 源码编译
```bash
# 克隆项目
git clone https://github.com/clint456/BleAgentService.git
cd BleAgentService

# 安装依赖
go mod tidy

# 编译项目
make build
# 或者
go build -o ble-agent-service ./cmd
```

#### 6.2.2 Docker部署
```dockerfile
FROM golang:1.21-alpine AS builder
WORKDIR /app
COPY . .
RUN go mod tidy && go build -o ble-agent-service ./cmd

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY --from=builder /app/ble-agent-service .
COPY --from=builder /app/cmd/res ./res
CMD ["./ble-agent-service"]
```

#### 6.2.3 服务配置
```bash
# 设置串口权限
sudo usermod -a -G dialout $USER
sudo chmod 666 /dev/ttyS3

# 配置服务
sudo cp ble-agent-service /usr/local/bin/
sudo cp -r cmd/res /etc/ble-agent-service/

# 创建systemd服务
sudo tee /etc/systemd/system/ble-agent-service.service > /dev/null <<EOF
[Unit]
Description=BLE Agent Service
After=network.target

[Service]
Type=simple
User=edgex
ExecStart=/usr/local/bin/ble-agent-service
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

# 启动服务
sudo systemctl enable ble-agent-service
sudo systemctl start ble-agent-service
```

### 6.3 监控和维护

#### 6.3.1 日志管理
```bash
# 查看服务日志
journalctl -u ble-agent-service -f

# 设置日志级别
export EDGEX_LOGGING_LEVEL=DEBUG

# 日志轮转配置
sudo tee /etc/logrotate.d/ble-agent-service > /dev/null <<EOF
/var/log/ble-agent-service/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 644 edgex edgex
}
EOF
```

#### 6.3.2 健康检查
```bash
# 检查服务状态
curl -X GET http://localhost:59995/api/v4/ping

# 检查设备状态
curl -X GET http://localhost:59882/api/v4/device/name/Uart-Ble-Device

# 检查MQTT连接
mosquitto_sub -h 192.168.8.196 -t "edgex/events/#" -v
```

#### 6.3.3 性能监控
```bash
# 监控系统资源
top -p $(pgrep ble-agent-service)

# 监控网络连接
netstat -tulpn | grep 59995

# 监控串口状态
dmesg | grep ttyS3
```

## 7. 故障排除

### 7.1 常见问题

#### 7.1.1 串口连接问题
**问题**：串口连接失败
**解决方案**：
- 检查设备路径是否正确：`ls -l /dev/ttyS*`
- 确认波特率设置：115200
- 检查串口权限：`sudo chmod 666 /dev/ttyS3`
- 验证硬件连接

#### 7.1.2 MQTT连接问题
**问题**：MQTT连接失败
**解决方案**：
- 验证Broker地址和端口
- 检查网络连接：`ping 192.168.8.196`
- 确认认证信息
- 查看防火墙设置

#### 7.1.3 BLE初始化问题
**问题**：BLE初始化失败
**解决方案**：
- 检查AT命令响应
- 确认硬件模块正常工作
- 查看串口通信日志
- 重置BLE模块

### 7.2 调试技巧

#### 7.2.1 启用调试模式
```yaml
Writable:
  LogLevel: DEBUG
```

#### 7.2.2 串口调试
```bash
# 使用minicom测试串口
sudo minicom -D /dev/ttyS3 -b 115200

# 发送AT命令测试
AT+QRST
AT+QVERSION
```

#### 7.2.3 MQTT调试
```bash
# 订阅所有主题
mosquitto_sub -h 192.168.8.196 -t "#" -v

# 发布测试消息
mosquitto_pub -h 192.168.8.196 -t "test/topic" -m "test message"
```

## 8. 扩展和定制

### 8.1 功能扩展

#### 8.1.1 添加新的AT命令
```go
// 在bleCommand.go中添加新命令
const (
    ATNEWCOMMAND BleCommand = "AT+NEWCMD\r\n"
)

// 在BleController中添加新方法
func (b *BleController) ExecuteNewCommand() error {
    _, err := b.sendCommand(ATNEWCOMMAND)
    return err
}
```

#### 8.1.2 自定义数据转换
```go
func (s *Driver) customDataTransform(data map[string]interface{}) map[string]interface{} {
    // 实现自定义数据转换逻辑
    transformed := make(map[string]interface{})
    // ... 转换逻辑
    return transformed
}
```

#### 8.1.3 新增设备资源
```yaml
# 在profiles/generic.yaml中添加新资源
deviceResources:
  - name: "CustomResource"
    isHidden: false
    description: "Custom data resource"
    properties:
      valueType: "Float64"
      readWrite: "RW"
```

### 8.2 性能优化

#### 8.2.1 并发处理优化
```go
// 使用goroutine池处理并发请求
type WorkerPool struct {
    workers chan chan SerialRequest
    quit    chan bool
}

func (wp *WorkerPool) Start() {
    for i := 0; i < numWorkers; i++ {
        worker := NewWorker(wp.workers)
        worker.Start()
    }
}
```

#### 8.2.2 内存优化
```go
// 使用对象池减少内存分配
var messagePool = sync.Pool{
    New: func() interface{} {
        return &types.MessageEnvelope{}
    },
}

func getMessageEnvelope() *types.MessageEnvelope {
    return messagePool.Get().(*types.MessageEnvelope)
}
```

#### 8.2.3 缓存优化
```go
// 实现LRU缓存
type LRUCache struct {
    capacity int
    cache    map[string]*list.Element
    list     *list.List
    mutex    sync.RWMutex
}
```

## 9. 总结

BLE Agent Service 是一个功能完整、架构清晰的蓝牙代理服务，成功实现了手机App与EdgeX微服务之间的桥接功能。该服务具有以下特点：

### 9.1 技术优势
- **模块化设计**：各组件职责清晰，易于维护和扩展
- **高性能**：采用Go语言并发特性，支持高并发处理
- **可靠性**：完善的错误处理和重试机制
- **标准化**：完全符合EdgeX Foundry框架规范

### 9.2 应用价值
- **物联网集成**：为物联网设备提供统一的接入方案
- **移动化管理**：通过手机App实现设备的移动化管理
- **数据代理**：实现数据格式转换和重新分发
- **生态兼容**：与EdgeX生态系统完全兼容

### 9.3 发展方向
- **协议扩展**：支持更多通信协议
- **安全增强**：加强数据传输安全性
- **AI集成**：集成人工智能算法
- **云端集成**：支持云端服务集成

该设计方案为BLE Agent Service的开发、部署和维护提供了全面的指导，确保项目能够稳定、高效地运行在生产环境中。